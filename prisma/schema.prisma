// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  // remove output for now (simplifies imports)
}

datasource db {
  provider = "postgresql"
}

// prisma/schema.prisma

// -----------------------------
// Practice / Learning Models
// -----------------------------

model PracticeModule {
  id          String   @id @default(cuid())
  slug        String   @unique
  title       String
  description String?
  order       Int      @default(0)

  // optional but useful for “Weeks 1–2”
  weekStart   Int?
  weekEnd     Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  sections PracticeSection[]
  topics   PracticeTopic[]

  @@index([order])
}

// ✅ Scalable topic table (replaces enum PracticeTopic)
model PracticeTopic {
  id          String   @id @default(cuid())
  slug        String   @unique // e.g. "m0.dot", "m2.matmul"
  titleKey    String
  description String?
  order       Int      @default(0)
  meta        Json?

  // ✅ NEW: which generator engine to use (small set)
  genKey      String?

  moduleId String?
  module   PracticeModule? @relation(fields: [moduleId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  sectionLinks    PracticeSectionTopic[]
  assignmentLinks AssignmentTopic[]
  instances       PracticeQuestionInstance[]

  @@index([moduleId, order])
  @@index([genKey])
}


// Join table: Section <-> Topic
model PracticeSectionTopic {
  sectionId String
  topicId   String
  order     Int @default(0)

  section PracticeSection @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  topic   PracticeTopic   @relation(fields: [topicId], references: [id], onDelete: Cascade)

  @@id([sectionId, topicId])
  @@index([topicId])
  @@index([sectionId, order])
}

// Join table: Assignment <-> Topic
model AssignmentTopic {
  assignmentId String
  topicId      String
  order        Int @default(0)

  assignment Assignment    @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  topic      PracticeTopic @relation(fields: [topicId], references: [id], onDelete: Cascade)

  @@id([assignmentId, topicId])
  @@index([topicId])
  @@index([assignmentId, order])
}

enum PracticeKind {
  single_choice
  multi_choice
  numeric
  vector_drag_target
  vector_drag_dot
  matrix_input
}

enum PracticeDifficulty {
  easy
  medium
  hard
}

enum PracticeSessionStatus {
  active
  completed
}

model PracticeQuestionInstance {
  id String @id @default(cuid())

  sessionId String?
  session   PracticeSession? @relation(fields: [sessionId], references: [id], onDelete: SetNull)

  // ✅ Topic is now a FK to PracticeTopic
  topicId String
  topic   PracticeTopic @relation(fields: [topicId], references: [id], onDelete: Restrict)

  kind       PracticeKind
  difficulty PracticeDifficulty

  title  String
  prompt String

  // Public data sent to client (options, initial vectors, etc.)
  publicPayload Json

  // Secret data used only by server (correct answer, tolerance, etc.)
  secretPayload Json

  createdAt  DateTime  @default(now())
  answeredAt DateTime?

  attempts PracticeAttempt[]

  @@index([sessionId])
  @@index([topicId, difficulty])
}

model PracticeAttempt {
  id String @id @default(cuid())

  sessionId String?
  session   PracticeSession? @relation(fields: [sessionId], references: [id], onDelete: SetNull)

  instanceId String
  instance   PracticeQuestionInstance @relation(fields: [instanceId], references: [id], onDelete: Cascade)

  // actor
  userId  String?
  guestId String?

  answerPayload Json
  ok            Boolean

  revealUsed Boolean @default(false)

  createdAt DateTime @default(now())

  @@index([sessionId])
  @@index([instanceId])
  @@index([userId])
  @@index([guestId])
}

enum AssignmentStatus {
  draft
  published
  archived
}

model PracticeSection {
  id          String @id @default(cuid())
  slug        String @unique
  title       String
  description String?
  order       Int    @default(0)

  // ✅ topics are now scalable via join table
  topics PracticeSectionTopic[]

  moduleId String?
  module   PracticeModule? @relation(fields: [moduleId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  meta      Json? // ✅ store module info (weeks, bullets, skills, etc.)

  sessions    PracticeSession[]
  assignments Assignment[] @relation("SectionAssignments")

  @@index([moduleId])
}

model PracticeSession {
  id     String                @id @default(cuid())
  status PracticeSessionStatus @default(active)

  userId  String?
  guestId String?

  sectionId String
  section   PracticeSection @relation(fields: [sectionId], references: [id], onDelete: Restrict)

  difficulty  PracticeDifficulty
  targetCount Int @default(10)

  total   Int @default(0)
  correct Int @default(0)

  startedAt      DateTime  @default(now())
  completedAt    DateTime?
  lastInstanceId String?

  assignmentId String?
  assignment   Assignment? @relation("AssignmentSessions", fields: [assignmentId], references: [id], onDelete: SetNull)

  instances PracticeQuestionInstance[]
  attempts  PracticeAttempt[]

  @@index([assignmentId])
  @@index([sectionId])
}

model Assignment {
  id          String           @id @default(cuid())
  slug        String           @unique
  title       String
  description String?
  status      AssignmentStatus @default(draft)

  sectionId String
  section   PracticeSection @relation("SectionAssignments", fields: [sectionId], references: [id], onDelete: Restrict)

  // ✅ topics are now scalable via join table
  topics AssignmentTopic[]

  difficulty    PracticeDifficulty
  questionCount Int @default(10)

  availableFrom DateTime?
  dueAt         DateTime?
  timeLimitSec  Int?

  maxAttempts Int?
  allowReveal Boolean @default(false)
  showDebug   Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  sessions PracticeSession[] @relation("AssignmentSessions")

  @@index([sectionId])
}

// -----------------------------
// Auth.js / NextAuth Models
// -----------------------------

model User {
  id            String   @id @default(cuid())
  name          String?
  email         String?  @unique
  emailVerified DateTime?
  image         String?

  // Stripe
  stripeCustomerId String? @unique
  trialUsedAt      DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  accounts      Account[]
  sessions      Session[]
  subscriptions Subscription[]
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String

  refresh_token String? @db.Text
  access_token  String? @db.Text
  expires_at    Int?
  token_type    String?
  scope         String?
  id_token      String? @db.Text
  session_state String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// -----------------------------
// Stripe Subscription Tracking
// -----------------------------

enum StripeSubscriptionStatus {
  trialing
  active
  past_due
  unpaid
  canceled
  incomplete
  incomplete_expired
  paused
}

model Subscription {
  id                   String                   @id @default(cuid())
  userId               String
  stripeCustomerId     String
  stripeSubscriptionId String                   @unique
  status               StripeSubscriptionStatus
  priceId              String?

  currentPeriodEnd  DateTime?
  cancelAtPeriodEnd Boolean @default(false)
  trialEnd          DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([stripeCustomerId])
  @@index([status])
}