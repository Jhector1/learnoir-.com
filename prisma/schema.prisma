// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  // remove output for now (simplifies imports)
}

datasource db {
  provider = "postgresql"
}

// prisma/schema.prisma

enum PracticeTopic {
  dot
  projection
  angle
  vectors
}

enum PracticeKind {
  single_choice
  multi_choice
  numeric
  vector_drag_target
  vector_drag_dot
}

enum PracticeDifficulty {
  easy
  medium
  hard
}

enum PracticeSessionStatus {
  active
  completed
}

model PracticeQuestionInstance {
  id String @id @default(cuid())

  sessionId String?
  session   PracticeSession? @relation(fields: [sessionId], references: [id], onDelete: SetNull)

  topic      PracticeTopic
  kind       PracticeKind
  difficulty PracticeDifficulty

  title  String
  prompt String

  // Public data sent to client (options, initial vectors, etc.)
  publicPayload Json

  // Secret data used only by server (correct answer, tolerance, etc.)
  secretPayload Json

  createdAt  DateTime  @default(now())
  answeredAt DateTime?

  attempts PracticeAttempt[]

  @@index([sessionId])
  @@index([topic, difficulty])
}

model PracticeAttempt {
  id String @id @default(cuid())

  sessionId String?
  session   PracticeSession? @relation(fields: [sessionId], references: [id], onDelete: SetNull)

  instanceId String
  instance   PracticeQuestionInstance @relation(fields: [instanceId], references: [id], onDelete: Cascade)

  // actor
  userId  String?
  guestId String?

  answerPayload Json
  ok            Boolean

  revealUsed Boolean @default(false)

  createdAt DateTime @default(now())

  @@index([sessionId])
  @@index([instanceId])
  @@index([userId])
  @@index([guestId])
}

enum AssignmentStatus {
  draft
  published
  archived
}

model PracticeSection {
  id          String          @id @default(cuid())
  slug        String          @unique
  title       String
  description String?
  order       Int             @default(0)
  topics      PracticeTopic[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  sessions    PracticeSession[]
  assignments Assignment[]      @relation("SectionAssignments")
}

model PracticeSession {
  id     String                @id @default(cuid())
  status PracticeSessionStatus @default(active)

  userId  String?
  guestId String?

  sectionId String
  section   PracticeSection @relation(fields: [sectionId], references: [id], onDelete: Restrict)

  difficulty  PracticeDifficulty
  targetCount Int                @default(10)

  total   Int @default(0)
  correct Int @default(0)

  startedAt      DateTime  @default(now())
  completedAt    DateTime?
  lastInstanceId String?

  assignmentId String?
  assignment   Assignment? @relation("AssignmentSessions", fields: [assignmentId], references: [id], onDelete: SetNull)

  instances PracticeQuestionInstance[]
  attempts  PracticeAttempt[]

  @@index([assignmentId])
  @@index([sectionId])
}

model Assignment {
  id          String           @id @default(cuid())
  slug        String           @unique
  title       String
  description String?
  status      AssignmentStatus @default(draft)

  sectionId String
  section   PracticeSection @relation("SectionAssignments", fields: [sectionId], references: [id], onDelete: Restrict)

  topics        PracticeTopic[]
  difficulty    PracticeDifficulty
  questionCount Int                @default(10)

  availableFrom DateTime?
  dueAt         DateTime?
  timeLimitSec  Int?

  maxAttempts Int?
  allowReveal Boolean @default(false)
  showDebug   Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  sessions PracticeSession[] @relation("AssignmentSessions")

  @@index([sectionId])
}











// --- Auth.js / NextAuth tables (Prisma Adapter) ---
model User {
  id            String   @id @default(cuid())
  name          String?
  email         String?  @unique
  emailVerified DateTime?
  image         String?

  // Stripe
  stripeCustomerId String? @unique
  trialUsedAt      DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  accounts      Account[]
  sessions      Session[]
  subscriptions Subscription[]
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String

  refresh_token String? @db.Text
  access_token  String? @db.Text
  expires_at    Int?
  token_type    String?
  scope         String?
  id_token      String? @db.Text
  session_state String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// --- Stripe subscription tracking ---
enum StripeSubscriptionStatus {
  trialing
  active
  past_due
  unpaid
  canceled
  incomplete
  incomplete_expired
  paused
}

model Subscription {
  id                   String                    @id @default(cuid())
  userId               String
  stripeCustomerId     String
  stripeSubscriptionId String                    @unique
  status               StripeSubscriptionStatus
  priceId              String?

  currentPeriodEnd     DateTime?
  cancelAtPeriodEnd    Boolean                   @default(false)
  trialEnd             DateTime?

  createdAt            DateTime                  @default(now())
  updatedAt            DateTime                  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([stripeCustomerId])
  @@index([status])
}
